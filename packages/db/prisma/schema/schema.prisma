generator client {
  provider = "prisma-client-js"
  output   = "../generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  emailVerified      Boolean           @default(false)
  name               String
  phone              String?
  avatar             String?
  password           String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  lastLoginAt        DateTime?
  accounts           Account[]
  aiConversations    AIConversation[]
  aiInsights         AIInsight[]       @relation("InsightCreator")
  auditLogs          AuditLog[]
  companyMemberships CompanyMember[]
  reports            GeneratedReport[] @relation("ReportCreator")
  notifications      Notification[]
  projects           Project[]         @relation("ProjectCreator")
  sessions           Session[]
  tasks              Task[]            @relation("TaskAssignee")
  workflows          Workflow[]        @relation("WorkflowCreator")

  @@index([email])
  @@index([createdAt])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Company {
  id                String             @id @default(cuid())
  name              String
  slug              String             @unique
  logo              String?
  industry          String?
  size              String?
  taxId             String?            @unique
  address           String?
  city              String?
  country           String             @default("Ethiopia")
  phone             String?
  email             String?
  website           String?
  plan              String             @default("free")
  planExpiry        DateTime?
  settings          Json               @default("{}")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  aiConversations   AIConversation[]
  aiInsights        AIInsight[]
  budgets           Budget[]
  members           CompanyMember[]
  departments       Department[]
  documents         Document[]
  financialAccounts FinancialAccount[]
  generatedReports  GeneratedReport[]
  integrations      Integration[]
  projects          Project[]
  reportTemplates   ReportTemplate[]
  transactions      Transaction[]
  workflows         Workflow[]

  @@index([slug])
  @@index([createdAt])
  @@map("companies")
}

model CompanyMember {
  id          String    @id @default(cuid())
  companyId   String
  userId      String
  role        String
  permissions Json      @default("[]")
  status      String    @default("active")
  invitedAt   DateTime  @default(now())
  joinedAt    DateTime?
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
  @@index([role])
  @@map("company_members")
}

model Department {
  id          String    @id @default(cuid())
  companyId   String
  name        String
  description String?
  headUserId  String?
  budget      Decimal?  @db.Decimal(15, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  budgets     Budget[]
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects    Project[]

  @@index([companyId])
  @@map("departments")
}

model Project {
  id           String      @id @default(cuid())
  companyId    String
  departmentId String?
  creatorId    String
  name         String
  description  String?
  status       String      @default("planning")
  priority     String      @default("medium")
  startDate    DateTime?
  endDate      DateTime?
  budget       Decimal?    @db.Decimal(15, 2)
  spent        Decimal     @default(0) @db.Decimal(15, 2)
  progress     Int         @default(0)
  tags         String[]
  attachments  Json        @default("[]")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  expenses     Expense[]
  milestones   Milestone[]
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator      User        @relation("ProjectCreator", fields: [creatorId], references: [id])
  department   Department? @relation(fields: [departmentId], references: [id])
  tasks        Task[]
  timeEntries  TimeEntry[]

  @@index([companyId])
  @@index([departmentId])
  @@index([creatorId])
  @@index([status])
  @@index([startDate])
  @@map("projects")
}

model Task {
  id             String      @id @default(cuid())
  projectId      String
  assigneeId     String?
  title          String
  description    String?
  status         String      @default("todo")
  priority       String      @default("medium")
  dueDate        DateTime?
  completedAt    DateTime?
  estimatedHours Decimal?    @db.Decimal(8, 2)
  actualHours    Decimal?    @db.Decimal(8, 2)
  parentTaskId   String?
  order          Int         @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  assignee       User?       @relation("TaskAssignee", fields: [assigneeId], references: [id])
  parentTask     Task?       @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subTasks       Task[]      @relation("TaskHierarchy")
  project        Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  timeEntries    TimeEntry[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

model Milestone {
  id          String    @id @default(cuid())
  projectId   String
  name        String
  description String?
  dueDate     DateTime
  status      String    @default("pending")
  achievedAt  DateTime?
  createdAt   DateTime  @default(now())
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([dueDate])
  @@map("milestones")
}

model TimeEntry {
  id          String   @id @default(cuid())
  projectId   String
  taskId      String?
  userId      String
  description String?
  hours       Decimal  @db.Decimal(8, 2)
  date        DateTime
  billable    Boolean  @default(true)
  hourlyRate  Decimal? @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?    @relation(fields: [taskId], references: [id])

  @@index([projectId])
  @@index([taskId])
  @@index([userId])
  @@index([date])
  @@map("time_entries")
}

model FinancialAccount {
  id           String        @id @default(cuid())
  companyId    String
  name         String
  type         String
  category     String?
  code         String?
  balance      Decimal       @default(0) @db.Decimal(15, 2)
  currency     String        @default("ETB")
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([companyId, code])
  @@index([companyId])
  @@index([type])
  @@map("financial_accounts")
}

model Transaction {
  id              String           @id @default(cuid())
  companyId       String
  accountId       String
  type            String
  amount          Decimal          @db.Decimal(15, 2)
  currency        String           @default("ETB")
  description     String
  reference       String?
  category        String?
  date            DateTime
  attachments     Json             @default("[]")
  aiExtractedData Json?
  reconciled      Boolean          @default(false)
  reconciledAt    DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  account         FinancialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([accountId])
  @@index([date])
  @@index([category])
  @@map("transactions")
}

model Budget {
  id             String      @id @default(cuid())
  companyId      String
  departmentId   String?
  name           String
  description    String?
  startDate      DateTime
  endDate        DateTime
  totalAmount    Decimal     @db.Decimal(15, 2)
  spent          Decimal     @default(0) @db.Decimal(15, 2)
  categories     Json        @default("[]")
  alertThreshold Int         @default(80)
  status         String      @default("active")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  company        Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department     Department? @relation(fields: [departmentId], references: [id])

  @@index([companyId])
  @@index([departmentId])
  @@index([startDate, endDate])
  @@map("budgets")
}

model Expense {
  id          String    @id @default(cuid())
  projectId   String
  description String
  amount      Decimal   @db.Decimal(15, 2)
  currency    String    @default("ETB")
  category    String
  date        DateTime
  status      String    @default("pending")
  approvedBy  String?
  approvedAt  DateTime?
  receipts    Json      @default("[]")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
  @@index([status])
  @@map("expenses")
}

model AIConversation {
  id           String   @id @default(cuid())
  userId       String
  companyId    String
  title        String?
  messages     Json     @default("[]")
  context      Json?
  tags         String[]
  messageCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AIInsight {
  id          String    @id @default(cuid())
  companyId   String
  createdBy   String?
  type        String
  category    String?
  title       String
  description String
  severity    String    @default("info")
  data        Json
  actionable  Boolean   @default(false)
  actions     Json?
  status      String    @default("active")
  resolvedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator     User?     @relation("InsightCreator", fields: [createdBy], references: [id])

  @@index([companyId])
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("ai_insights")
}

model AIModel {
  id           String   @id @default(cuid())
  name         String   @unique
  type         String
  provider     String
  model        String
  config       Json     @default("{}")
  requestCount Int      @default(0)
  tokenCount   BigInt   @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([type])
  @@index([provider])
  @@map("ai_models")
}

model Workflow {
  id             String              @id @default(cuid())
  companyId      String
  createdBy      String
  name           String
  description    String?
  trigger        Json
  actions        Json                @default("[]")
  conditions     Json?
  isActive       Boolean             @default(true)
  executionCount Int                 @default(0)
  lastExecutedAt DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  executions     WorkflowExecution[]
  company        Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator        User                @relation("WorkflowCreator", fields: [createdBy], references: [id])

  @@index([companyId])
  @@index([createdBy])
  @@index([isActive])
  @@map("workflows")
}

model WorkflowExecution {
  id          String    @id @default(cuid())
  workflowId  String
  status      String
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int?
  logs        Json      @default("[]")
  error       String?
  triggerData Json?
  workflow    Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_executions")
}

model ReportTemplate {
  id          String            @id @default(cuid())
  companyId   String
  name        String
  description String?
  type        String
  category    String?
  template    Json
  aiPrompt    String?
  dataSources Json              @default("[]")
  schedule    String?
  recipients  String[]
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  reports     GeneratedReport[]
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([isActive])
  @@map("report_templates")
}

model GeneratedReport {
  id         String         @id @default(cuid())
  templateId String
  companyId  String
  createdBy  String
  name       String
  period     Json
  fileUrl    String?
  excelUrl   String?
  insights   String?
  summary    String?
  metadata   Json?
  isPublic   Boolean        @default(false)
  shareToken String?        @unique
  status     String         @default("generating")
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  company    Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator    User           @relation("ReportCreator", fields: [createdBy], references: [id])
  template   ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([companyId])
  @@index([createdBy])
  @@index([status])
  @@index([createdAt])
  @@map("generated_reports")
}

model Document {
  id            String    @id @default(cuid())
  companyId     String
  uploadedBy    String
  name          String
  type          String
  mimeType      String
  size          Int
  fileUrl       String
  thumbnailUrl  String?
  extractedData Json?
  ocrText       String?
  category      String?
  tags          String[]
  status        String    @default("pending")
  processedAt   DateTime?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([uploadedBy])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("documents")
}

model Integration {
  id          String    @id @default(cuid())
  companyId   String
  name        String
  provider    String
  type        String
  config      Json
  credentials Json?
  isActive    Boolean   @default(true)
  lastSyncAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([provider])
  @@index([isActive])
  @@map("integrations")
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  type        String
  title       String
  message     String
  actionUrl   String?
  actionText  String?
  relatedId   String?
  relatedType String?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  companyId String?
  action    String
  entity    String
  entityId  String?
  before    Json?
  after     Json?
  ipAddress String?
  userAgent String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String?
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_settings")
}
